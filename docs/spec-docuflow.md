## DocuFlow 機能仕様書

### 1. プロダクト概要

- **名称**: DocuFlow
- **概要**: 仕様書・議事録・提案書などのテキスト / PDF / Word ドキュメントをアップロードすると、OpenAI によりタイトル・要約・タグを自動生成し、検索しやすい形で蓄積・管理できるミニ SaaS。
- **ターゲットユーザー**
  - 個人開発者・PM・コンサルタントなど、ドキュメントが散らばりがちな個人
  - 軽いチーム利用を想定（本実装は 1 ユーザー単位）

---

## 🎯 ビジネスゴール & 成功指標

### ビジョン

> 「ドキュメントを探す時間をゼロにする」

散在するドキュメントを AI の力で瞬時に整理・検索可能にし、**知識の再利用**を劇的に効率化する。

### ビジネスゴール

| # | ゴール | 達成条件 |
|:-:|:-------|:---------|
| G1 | ドキュメント検索時間の短縮 | 従来5分かかっていた検索が30秒以内で完了 |
| G2 | ドキュメント整理の自動化 | 手動でのタイトル・タグ付け作業が90%削減 |
| G3 | ナレッジの再利用促進 | 過去ドキュメントの閲覧回数が月20%増加 |

### KPI（成功指標）

| 指標 | 定義 | 目標値 |
|:-----|:-----|:-------|
| WAU（週間アクティブユーザー） | 1週間に1回以上ログインしたユーザー数 | 継続的に増加 |
| ドキュメント作成数/週 | 新規作成されたドキュメント数 | 1ユーザーあたり3件以上 |
| AI要約利用率 | 要約生成ボタンが押された割合 | 80%以上 |
| 共有リンク発行率 | 共有機能が使われたドキュメントの割合 | 30%以上 |
| 検索成功率 | 検索後にドキュメントを開いた割合 | 70%以上 |

---

## 👤 ペルソナ（典型ユーザー像）

### ペルソナ 1: 佐藤さん（32歳・SaaS営業）

| 項目 | 内容 |
|:-----|:-----|
| **職種** | SaaS企業の営業マネージャー |
| **業務内容** | 週3〜5件の商談、提案書作成、社内報告 |
| **課題** | 過去の提案書や見積書が散らばっていて、類似案件を探すのに毎回15分以上かかる |
| **ゴール** | 商談前に過去の類似提案を3分以内に見つけたい |
| **利用シーン** | 商談準備中、移動中（スマホ）、週次報告作成時 |

**佐藤さんの声**:
> 「似たような案件、前にもやったはずなんだけど…どこに保存したっけ？」
> 「提案書の要点だけサッと確認して、上司に共有したい」

### ペルソナ 2: 田中さん（28歳・スタートアップPM）

| 項目 | 内容 |
|:-----|:-----|
| **職種** | スタートアップのプロダクトマネージャー |
| **業務内容** | 仕様書作成、議事録整理、ユーザーインタビュー記録 |
| **課題** | 議事録が溜まる一方で、後から見返すことがほとんどない |
| **ゴール** | 議事録を自動で要約し、決定事項だけを素早く振り返りたい |
| **利用シーン** | MTG直後、スプリント計画時、新メンバーへの引き継ぎ |

**田中さんの声**:
> 「議事録、書くだけ書いて誰も読まないんだよね…」
> 「3行で要約してくれたら、チームにも共有しやすいのに」

---

## 🧩 ユーザーストーリー（User Stories）

### US-01: AIによる自動要約

```
As a 営業担当
I want アップロードしたPDFが即座に要約される
So that 資料を全部読まなくても要点を把握できる
```

**受け入れ条件（Acceptance Criteria）**:
- [ ] 5MB / 20ページ以内のPDFが30秒以内に要約される
- [ ] 要約は日本語で3〜5行、文法的に破綻がない
- [ ] 要約生成中はローディング表示が出る
- [ ] エラー時は「要約の生成に失敗しました」と表示される

### US-02: タグによる高速フィルタリング

```
As a PM
I want ドキュメントをタグで素早くフィルタしたい
So that 関連する資料だけを一覧で確認できる
```

**受け入れ条件（Acceptance Criteria）**:
- [ ] タグをクリックすると、そのタグを持つドキュメントだけが表示される
- [ ] 複数タグでのAND検索ができる（将来対応）
- [ ] タグは最大3つまで自動生成される
- [ ] タグは手動で編集・追加・削除できる

### US-03: ワンクリック共有

```
As a チームメンバー
I want ドキュメントの共有リンクをワンクリックで発行したい
So that Slackやメールで素早く共有できる
```

**受け入れ条件（Acceptance Criteria）**:
- [ ] 「共有リンクを発行」ボタンを押すとURLが生成される
- [ ] URLをクリップボードにコピーできる
- [ ] 共有先は認証不要で閲覧できる（編集不可）
- [ ] 共有リンクはいつでも無効化できる

### US-04: 全文検索

```
As a ユーザー
I want タイトル・本文・要約・タグを横断して検索したい
So that キーワードを覚えていれば必ず見つけられる
```

**受け入れ条件（Acceptance Criteria）**:
- [ ] 検索窓にキーワードを入力すると即座にフィルタされる
- [ ] 大文字/小文字、全角/半角を区別しない
- [ ] 検索結果が0件の場合は「該当するドキュメントがありません」と表示
- [ ] 検索はクライアントサイドで高速に動作する

### US-05: バージョン履歴

```
As a ドキュメント作成者
I want 編集前の内容を後から確認したい
So that 誤って上書きしても元に戻せる
```

**受け入れ条件（Acceptance Criteria）**:
- [ ] 編集を保存するたびにバージョンが作成される
- [ ] 過去バージョンの一覧が表示される
- [ ] 過去バージョンの内容を閲覧できる
- [ ] 過去バージョンに「戻す」ことができる（将来対応）

---

## 🛡 非機能要件（詳細）

### パフォーマンス要件

| 項目 | 目標値 | 計測方法 |
|:-----|:-------|:---------|
| ページ読み込み時間（LCP） | < 2.5秒 | Lighthouse |
| API レスポンス時間（p95） | < 500ms | Vercel Analytics |
| AI要約生成時間 | < 30秒 | アプリログ |
| 検索レスポンス | < 100ms | クライアントサイド計測 |
| 同時接続ユーザー | 100人以上 | 負荷テスト |

### セキュリティ要件

| 項目 | 対策 |
|:-----|:-----|
| 認証 | Supabase Auth（メール/パスワード）、セッション管理 |
| 認可 | RLS（Row Level Security）で user_id 単位にスコープ |
| データ保護 | HTTPS通信、環境変数での機密情報管理 |
| XSS対策 | React のエスケープ、dangerouslySetInnerHTML 不使用 |
| CSRF対策 | SameSite Cookie、Origin チェック |
| 共有リンク | 推測困難なトークン（UUID v4）を使用 |

### 信頼性要件

| 項目 | 目標 |
|:-----|:-----|
| 稼働率（SLA） | 99.5%（月間ダウンタイム 3.6時間以内） |
| データバックアップ | Supabase の自動バックアップ（日次） |
| 障害復旧時間（RTO） | 1時間以内（Vercel ロールバック） |
| 障害復旧地点（RPO） | 24時間以内（日次バックアップ） |

### スケーラビリティ要件

| 項目 | 想定値 |
|:-----|:-------|
| ユーザー数 | 初期100人 → 将来1,000人 |
| ドキュメント数/ユーザー | 平均50件、最大500件 |
| ファイルサイズ | 最大10MB/ファイル |
| 同時アップロード | 1ファイル/リクエスト |

---

## ❗ エラーシナリオ & 期待する挙動

### エラー一覧

| # | シナリオ | 原因 | 表示メッセージ | 対処 |
|:-:|:---------|:-----|:---------------|:-----|
| E1 | AI要約生成失敗 | OpenAI API エラー | 「AI要約の生成に失敗しました。しばらくしてから再度お試しください。」 | リトライボタンを表示 |
| E2 | OpenAI レートリミット | API制限到達 | 「現在AI機能が混み合っています。数分後に再度お試しください。」 | 自動リトライ（3回まで） |
| E3 | 非対応ファイル形式 | .xlsx, .pptx 等 | 「サポートされていないファイル形式です。PDF / DOC / DOCX のみ対応しています。」 | 対応形式の案内 |
| E4 | ファイルサイズ超過 | 10MB超 | 「ファイルサイズが大きすぎます。10MB以下のファイルをアップロードしてください。」 | サイズ制限の明示 |
| E5 | PDF解析失敗 | 暗号化PDF等 | 「このPDFは読み取れません。保護されていないPDFをお試しください。」 | 別ファイルの案内 |
| E6 | 認証エラー | セッション切れ | 「セッションが切れました。再度ログインしてください。」 | ログイン画面へリダイレクト |
| E7 | ネットワークエラー | オフライン | 「ネットワーク接続を確認してください。」 | リトライボタン |
| E8 | 共有リンク無効 | トークン無効/削除済み | 「この共有リンクは無効です。」 | トップページへの案内 |
| E9 | ドキュメント未発見 | 削除済み/権限なし | 「ドキュメントが見つかりません。」 | ダッシュボードへの案内 |
| E10 | DB接続エラー | Supabase障害 | 「データの取得に失敗しました。しばらくしてから再度お試しください。」 | 自動リトライ |

### エラー表示のガイドライン

1. **技術用語を使わない**
   - ❌ `Error: ECONNREFUSED`
   - ✅ `サーバーに接続できません。しばらくしてから再度お試しください。`

2. **次のアクションを示す**
   - ❌ `エラーが発生しました`
   - ✅ `エラーが発生しました。ページを再読み込みしてください。`

3. **ユーザーのせいにしない**
   - ❌ `入力が間違っています`
   - ✅ `メールアドレスの形式を確認してください（例: user@example.com）`

---

### 2. ユースケース（概要）

1. **会議後の議事録整理**
   - ユーザーは `/new` に議事録テキストをペースト、または PDF をアップロード
   - DocuFlow がタイトル・要約・タグを自動生成
   - 後日 `/app` で「議題名」や「タグ」で検索して即座に再発見

2. **仕様書 / 企画書のナレッジベース**
   - プロダクト仕様書や企画書を Word / PDF のままアップロード
   - カテゴリ（仕様書 / 企画 / 提案 等）を付与
   - チームメンバーと共有リンクを発行し、閲覧専用 URL を共有

3. **学習ノートの整理**
   - 技術記事のまとめや学習ノートをコピー & ペーストで保存
   - AI 要約でポイントだけを素早く振り返り

### 3. 画面一覧

- `/`
  - ルート。ログイン状態に応じて `/app` または `/auth/login` にリダイレクト。
- `/auth/login`
  - メール & パスワードでログイン。
- `/auth/signup`
  - アカウント新規作成。
- `/auth/forgot` / `/auth/reset`
  - パスワードリセットフロー。
- `/auth/logout`
  - クッキー削除 & ログアウト処理。
- `/app`
  - ログイン後のダッシュボード。検索 / 一覧 / ピン / お気に入り / 最近のアクティビティ表示。
- `/new`
  - 新規ドキュメント作成（テキスト入力 or ファイルアップロード）。
- `/documents/[id]`
  - ドキュメント詳細表示・共有リンク発行 / 停止・削除。
- `/documents/[id]/edit`
  - ドキュメント編集（保存時にバージョン履歴を作成）。
- `/share/[token]`
  - 共有リンク閲覧用の公開ページ（認証不要・閲覧のみ）。
- `/settings`
  - 設定画面。パスワードリセットへの導線とアカウント削除機能を配置。

### 4. 機能要件

#### 4.1 認証

- メール & パスワードでのサインアップ / ログイン / パスワードリセットができること。
- ログイン状態はクッキー `docuhub_ai_auth` / `docuhub_ai_user_id` で判定し、`middleware.ts` で `/app`, `/new`, `/documents/*`, `/settings` を保護すること。

#### 4.2 ドキュメント CRUD

- ユーザーはタイトル・カテゴリ・本文を入力してドキュメントを作成できること。
- 一覧でタイトル / 要約 / 本文 / タグを対象にフルテキスト検索できること。
- カテゴリフィルタ、作成日の昇順 / 降順ソートができること。
- ドキュメント詳細 / 編集 / 削除が行えること。
- 更新前の内容は `document_versions` テーブルに保存すること。

#### 4.3 AI 要約・タグ・タイトル生成

- 本文（テキストまたは抽出テキスト）を入力とし、OpenAI `gpt-4.1-mini` で以下を生成する:
  - 日本語タイトル（最大 30 文字程度）
  - 3〜5 行程度の要約
  - 最大 3 つのタグ
- タイトルが未入力の場合のみ、自動タイトル生成を行う。

#### 4.4 ファイルアップロード

- `.pdf`, `.doc`, `.docx` を 1 ファイルまでアップロードできること。
- ファイルサイズは 10MB 以下に制限する。
- PDF は `pdf-parse`、Word は `mammoth` でテキスト抽出し、本文として保存する。

#### 4.5 共有リンク

- ドキュメント詳細から共有リンクを発行できること。
- `share_token` が存在する場合のみ `/share/[token]` で閲覧可能とする。
- 共有リンクはいつでも停止できる（`share_token` を null に更新）。

#### 4.6 アクティビティログ

- 作成 / 更新 / 削除 / お気に入り / ピン / 共有リンク有効化 / 無効化 / アカウント削除の操作を `activity_logs` に保存する。
- `/app` の「最近のアクティビティ」で直近 10 件を表示する。

#### 4.7 アカウント削除

- `/settings` からアカウント削除アクションを呼び出せること。
- 対象ユーザーの `documents` / `document_versions` を削除し、`supabaseAdmin` が有効な場合は Supabase Auth の user も削除する。

### 5. 非機能要件（簡易）

- **パフォーマンス**
  - ドキュメント一覧 `/app` は通常数百件程度を想定。
  - AI 要約生成は 1 リクエストあたり数秒以内を目標（OpenAI API 依存）。
- **セキュリティ**
  - クッキーは `httpOnly` ではなく学習用の簡易実装だが、README でその旨を明記。
  - 共有リンクは URL を知っている全員が閲覧可能であることを明示。
- **運用**
  - 本番環境は Vercel + Supabase を想定。
  - 開発環境と本番環境で `.env` の値を切り替える運用とする。

### 6. 制約・スコープ外

- 本実装では組織・チーム単位のワークスペース管理は行わない（単一ユーザー前提）。
- 高度なアクセス制御（ロールベース / 共有先ユーザーの限定）はスコープ外。
- RLS はポリシーのみ定義し、ローカル開発では disabled とする。
