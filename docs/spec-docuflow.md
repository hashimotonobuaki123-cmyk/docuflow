## DocuFlow 機能仕様書

### 1. プロダクト概要

- **名称**: DocuFlow
- **概要**: 仕様書・議事録・提案書などのテキスト / PDF / Word ドキュメントをアップロードすると、OpenAI によりタイトル・要約・タグを自動生成し、検索しやすい形で蓄積・管理できるミニ SaaS。
- **ターゲットユーザー**
  - 個人開発者・PM・コンサルタントなど、ドキュメントが散らばりがちな個人
  - 軽いチーム利用を想定（本実装は 1 ユーザー単位）

### 2. ユースケース

1. **会議後の議事録整理**
   - ユーザーは `/new` に議事録テキストをペースト、または PDF をアップロード
   - DocuFlow がタイトル・要約・タグを自動生成
   - 後日 `/app` で「議題名」や「タグ」で検索して即座に再発見

2. **仕様書 / 企画書のナレッジベース**
   - プロダクト仕様書や企画書を Word / PDF のままアップロード
   - カテゴリ（仕様書 / 企画 / 提案 等）を付与
   - チームメンバーと共有リンクを発行し、閲覧専用 URL を共有

3. **学習ノートの整理**
   - 技術記事のまとめや学習ノートをコピー & ペーストで保存
   - AI 要約でポイントだけを素早く振り返り

### 3. 画面一覧

- `/`
  - ルート。ログイン状態に応じて `/app` または `/auth/login` にリダイレクト。
- `/auth/login`
  - メール & パスワードでログイン。
- `/auth/signup`
  - アカウント新規作成。
- `/auth/forgot` / `/auth/reset`
  - パスワードリセットフロー。
- `/auth/logout`
  - クッキー削除 & ログアウト処理。
- `/app`
  - ログイン後のダッシュボード。検索 / 一覧 / ピン / お気に入り / 最近のアクティビティ表示。
- `/new`
  - 新規ドキュメント作成（テキスト入力 or ファイルアップロード）。
- `/documents/[id]`
  - ドキュメント詳細表示・共有リンク発行 / 停止・削除。
- `/documents/[id]/edit`
  - ドキュメント編集（保存時にバージョン履歴を作成）。
- `/share/[token]`
  - 共有リンク閲覧用の公開ページ（認証不要・閲覧のみ）。
- `/settings`
  - 設定画面。パスワードリセットへの導線とアカウント削除機能を配置。

### 4. 機能要件

#### 4.1 認証

- メール & パスワードでのサインアップ / ログイン / パスワードリセットができること。
- ログイン状態はクッキー `docuhub_ai_auth` / `docuhub_ai_user_id` で判定し、`middleware.ts` で `/app`, `/new`, `/documents/*`, `/settings` を保護すること。

#### 4.2 ドキュメント CRUD

- ユーザーはタイトル・カテゴリ・本文を入力してドキュメントを作成できること。
- 一覧でタイトル / 要約 / 本文 / タグを対象にフルテキスト検索できること。
- カテゴリフィルタ、作成日の昇順 / 降順ソートができること。
- ドキュメント詳細 / 編集 / 削除が行えること。
- 更新前の内容は `document_versions` テーブルに保存すること。

#### 4.3 AI 要約・タグ・タイトル生成

- 本文（テキストまたは抽出テキスト）を入力とし、OpenAI `gpt-4.1-mini` で以下を生成する:
  - 日本語タイトル（最大 30 文字程度）
  - 3〜5 行程度の要約
  - 最大 3 つのタグ
- タイトルが未入力の場合のみ、自動タイトル生成を行う。

#### 4.4 ファイルアップロード

- `.pdf`, `.doc`, `.docx` を 1 ファイルまでアップロードできること。
- ファイルサイズは 10MB 以下に制限する。
- PDF は `pdf-parse`、Word は `mammoth` でテキスト抽出し、本文として保存する。

#### 4.5 共有リンク

- ドキュメント詳細から共有リンクを発行できること。
- `share_token` が存在する場合のみ `/share/[token]` で閲覧可能とする。
- 共有リンクはいつでも停止できる（`share_token` を null に更新）。

#### 4.6 アクティビティログ

- 作成 / 更新 / 削除 / お気に入り / ピン / 共有リンク有効化 / 無効化 / アカウント削除の操作を `activity_logs` に保存する。
- `/app` の「最近のアクティビティ」で直近 10 件を表示する。

#### 4.7 アカウント削除

- `/settings` からアカウント削除アクションを呼び出せること。
- 対象ユーザーの `documents` / `document_versions` を削除し、`supabaseAdmin` が有効な場合は Supabase Auth の user も削除する。

### 5. 非機能要件（簡易）

- **パフォーマンス**
  - ドキュメント一覧 `/app` は通常数百件程度を想定。
  - AI 要約生成は 1 リクエストあたり数秒以内を目標（OpenAI API 依存）。
- **セキュリティ**
  - クッキーは `httpOnly` ではなく学習用の簡易実装だが、README でその旨を明記。
  - 共有リンクは URL を知っている全員が閲覧可能であることを明示。
- **運用**
  - 本番環境は Vercel + Supabase を想定。
  - 開発環境と本番環境で `.env` の値を切り替える運用とする。

### 6. 制約・スコープ外

- 本実装では組織・チーム単位のワークスペース管理は行わない（単一ユーザー前提）。
- 高度なアクセス制御（ロールベース / 共有先ユーザーの限定）はスコープ外。
- RLS はポリシーのみ定義し、ローカル開発では disabled とする。
